<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Live Feed - Full Database (Dynamic)</title>
    <!-- Add any CSS links or styles here if needed -->
</head>
<body>
    <h1>Live Feed</h1>

    <!-- New section for configurable backend URL -->
    <div>
        Backend URL: <input type="text" id="backendUrlInput" placeholder="e.g., https://your-temp.trycloudflare.com" style="width: 300px;">
        <button id="saveUrlButton">Save URL</button>
        <p id="currentUrlDisplay">Current saved URL: none</p>
    </div>

    <div>
        Table: <select id="tableSelect"></select>
    </div>

    <div>
        Search: <input type="text" id="searchInput" placeholder="Search...">
    </div>

    <button id="refreshButton">Refresh Now</button>

    <p>Auto-refresh every 15 minutes. Scroll to bottom to load more pages.</p>

    <table id="dataTable">
        <thead id="tableHeader"></thead>
        <tbody id="tableBody"></tbody>
    </table>

    <script>
        // Key variable for backend URL (loaded from localStorage)
        let baseUrl = localStorage.getItem('backendUrl') || '';

        // Display current saved URL
        const currentUrlDisplay = document.getElementById('currentUrlDisplay');
        currentUrlDisplay.textContent = `Current saved URL: ${baseUrl || 'none (set one to load data)'}`;

        // Handle saving new URL
        const backendUrlInput = document.getElementById('backendUrlInput');
        const saveUrlButton = document.getElementById('saveUrlButton');
        saveUrlButton.addEventListener('click', () => {
            baseUrl = backendUrlInput.value.trim();
            if (baseUrl) {
                localStorage.setItem('backendUrl', baseUrl);
                currentUrlDisplay.textContent = `Current saved URL: ${baseUrl}`;
                alert('URL saved! Refresh the page or click "Refresh Now" to load data.');
                loadTables(); // Reload tables to test the new URL
            } else {
                alert('Please enter a valid URL.');
            }
        });

        // If no URL is set, prompt the user on load
        if (!baseUrl) {
            const promptedUrl = prompt('No backend URL set. Enter your Cloudflare tunnel URL (e.g., https://your-temp.trycloudflare.com):');
            if (promptedUrl) {
                baseUrl = promptedUrl.trim();
                localStorage.setItem('backendUrl', baseUrl);
                currentUrlDisplay.textContent = `Current saved URL: ${baseUrl}`;
            }
        }

        // Your existing JS for loading tables and data (adapted to use baseUrl)
        const tableSelect = document.getElementById('tableSelect');
        const searchInput = document.getElementById('searchInput');
        const refreshButton = document.getElementById('refreshButton');
        const tableHeader = document.getElementById('tableHeader');
        const tableBody = document.getElementById('tableBody');

        let currentTable = '';
        let currentPage = 1;
        const pageSize = 100; // Match your backend default
        let isLoading = false;

        // Function to load list of tables
        async function loadTables() {
            if (!baseUrl) return alert('Set a backend URL first.');
            try {
                const response = await fetch(`${baseUrl}/tables`);
                if (!response.ok) throw new Error('Failed to fetch tables');
                const tables = await response.json();
                tableSelect.innerHTML = tables.map(table => `<option value="${table}">${table}</option>`).join('');
                if (tables.length > 0) {
                    currentTable = tables[0];
                    tableSelect.value = currentTable;
                    loadData();
                }
            } catch (error) {
                console.error(error);
                alert('Error loading tables: ' + error.message);
            }
        }

        // Function to load paginated data
        async function loadData(append = false) {
            if (!baseUrl || !currentTable || isLoading) return;
            isLoading = true;
            try {
                const query = searchInput.value.trim();
                const url = `${baseUrl}/feed?table=${currentTable}&page=${currentPage}&page_size=${pageSize}${query ? `&q=${encodeURIComponent(query)}` : ''}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to fetch data');
                const { data, total_rows, rows_returned } = await response.json();

                if (!append) {
                    tableBody.innerHTML = ''; // Clear for new search or table
                    if (data.length > 0) {
                        const headers = Object.keys(data[0]);
                        tableHeader.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
                    }
                }

                data.forEach(row => {
                    const tr = document.createElement('tr');
                    Object.values(row).forEach(val => {
                        const td = document.createElement('td');
                        td.textContent = val;
                        tr.appendChild(td);
                    });
                    tableBody.appendChild(tr);
                });

                if (rows_returned > 0) currentPage++;
            } catch (error) {
                console.error(error);
                alert('Error loading data: ' + error.message);
            } finally {
                isLoading = false;
            }
        }

        // Event listeners
        tableSelect.addEventListener('change', () => {
            currentTable = tableSelect.value;
            currentPage = 1;
            loadData();
        });

        searchInput.addEventListener('input', () => {
            currentPage = 1;
            loadData();
        });

        refreshButton.addEventListener('click', () => {
            currentPage = 1;
            loadData();
        });

        // Infinite scroll (scroll to bottom to load more)
        window.addEventListener('scroll', () => {
            if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) {
                loadData(true); // Append mode
            }
        });

        // Auto-refresh every 15 minutes
        setInterval(() => {
            currentPage = 1;
            loadData();
        }, 15 * 60 * 1000);

        // Initial load
        loadTables();
    </script>
</body>
</html>
